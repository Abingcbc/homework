<!DOCTYPE html>

<html>
<head>
  <title>search_facet.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="search_facets.html">
                search_facets.js
              </a>
            
              
              <a class="source" href="search_query.html">
                search_query.js
              </a>
            
              
              <a class="source" href="templates.html">
                templates.js
              </a>
            
              
              <a class="source" href="backbone_extensions.html">
                backbone_extensions.js
              </a>
            
              
              <a class="source" href="hotkeys.html">
                hotkeys.js
              </a>
            
              
              <a class="source" href="inflector.html">
                inflector.js
              </a>
            
              
              <a class="source" href="jquery_extensions.html">
                jquery_extensions.js
              </a>
            
              
              <a class="source" href="search_parser.html">
                search_parser.js
              </a>
            
              
              <a class="source" href="search_box.html">
                search_box.js
              </a>
            
              
              <a class="source" href="search_facet.html">
                search_facet.js
              </a>
            
              
              <a class="source" href="search_input.html">
                search_input.js
              </a>
            
              
              <a class="source" href="visualsearch.html">
                visualsearch.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>search_facet.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

<span class="hljs-keyword">var</span> $ = jQuery; <span class="hljs-comment">// Handle namespaced jQuery</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is the visual search facet that holds the category and its autocompleted
input field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>VS.ui.SearchFacet = Backbone.View.extend({

  type : <span class="hljs-string">'facet'</span>,

  className : <span class="hljs-string">'search_facet'</span>,

  events : {
    <span class="hljs-string">'click .category'</span>           : <span class="hljs-string">'selectFacet'</span>,
    <span class="hljs-string">'keydown input'</span>             : <span class="hljs-string">'keydown'</span>,
    <span class="hljs-string">'mousedown input'</span>           : <span class="hljs-string">'enableEdit'</span>,
    <span class="hljs-string">'mouseover .VS-icon-cancel'</span> : <span class="hljs-string">'showDelete'</span>,
    <span class="hljs-string">'mouseout .VS-icon-cancel'</span>  : <span class="hljs-string">'hideDelete'</span>,
    <span class="hljs-string">'click .VS-icon-cancel'</span>     : <span class="hljs-string">'remove'</span>
  },

  initialize : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> {</span>
    <span class="hljs-keyword">this</span>.options = _.extend({}, <span class="hljs-keyword">this</span>.options, options);

    <span class="hljs-keyword">this</span>.flags = {
      canClose : <span class="hljs-literal">false</span>
    };
    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'set'</span>, <span class="hljs-string">'keydown'</span>, <span class="hljs-string">'deselectFacet'</span>, <span class="hljs-string">'deferDisableEdit'</span>);
    <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.options.app;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Rendering the facet sets up autocompletion, events on blur, and populates
the facet’s input with its starting value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    $(<span class="hljs-keyword">this</span>.el).html(JST[<span class="hljs-string">'search_facet'</span>]({
      model : <span class="hljs-keyword">this</span>.model,
      readOnly: <span class="hljs-keyword">this</span>.app.options.readOnly
    }));

    <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'not'</span>, <span class="hljs-string">'editing'</span>);
    <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'not'</span>, <span class="hljs-string">'selected'</span>);
    <span class="hljs-keyword">this</span>.box = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'input'</span>);
    <span class="hljs-keyword">this</span>.box.val(<span class="hljs-keyword">this</span>.model.label());
    <span class="hljs-keyword">this</span>.box.bind(<span class="hljs-string">'blur'</span>, <span class="hljs-keyword">this</span>.deferDisableEdit);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Handle paste events with <code>propertychange</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.box.bind(<span class="hljs-string">'input propertychange'</span>, <span class="hljs-keyword">this</span>.keydown);
    <span class="hljs-keyword">this</span>.setupAutocomplete();

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>This method is used to setup the facet’s input to auto-grow.
This is defered in the searchBox so it can be attached to the
DOM to get the correct font-size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  calculateSize : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.box.autoGrowInput();
    <span class="hljs-keyword">this</span>.box.unbind(<span class="hljs-string">'updated.autogrow'</span>);
    <span class="hljs-keyword">this</span>.box.bind(<span class="hljs-string">'updated.autogrow'</span>, _.bind(<span class="hljs-keyword">this</span>.moveAutocomplete, <span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Forces a recalculation of this facet’s input field’s value. Called when
the facet is focused, removed, or otherwise modified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resize : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">this</span>.box.trigger(<span class="hljs-string">'resize.autogrow'</span>, e);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Watches the facet’s input field to see if it matches the beginnings of
words in <code>autocompleteValues</code>, which is different for every category.
If the value, when selected from the autocompletion menu, is different
than what it was, commit the facet and search for it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setupAutocomplete : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.box.autocomplete({
      source    : _.bind(<span class="hljs-keyword">this</span>.autocompleteValues, <span class="hljs-keyword">this</span>),
      minLength : <span class="hljs-number">0</span>,
      delay     : <span class="hljs-number">0</span>,
      autoFocus : <span class="hljs-literal">true</span>,
      position  : {offset : <span class="hljs-string">"0 5"</span>},
      create    : _.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, ui)</span> {</span>
        $(<span class="hljs-keyword">this</span>.el).find(<span class="hljs-string">'.ui-autocomplete-input'</span>).css(<span class="hljs-string">'z-index'</span>,<span class="hljs-string">'auto'</span>);
      }, <span class="hljs-keyword">this</span>),
      select    : _.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, ui)</span> {</span>
        e.preventDefault();
        <span class="hljs-keyword">var</span> originalValue = <span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'value'</span>);
        <span class="hljs-keyword">this</span>.set(ui.item.value);
        <span class="hljs-keyword">if</span> (originalValue != ui.item.value || <span class="hljs-keyword">this</span>.box.val() != ui.item.value) {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.autosearch) {
            <span class="hljs-keyword">this</span>.search(e);
          } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">this</span>.app.searchBox.renderFacets();
              <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, <span class="hljs-number">1</span>, {viewPosition: <span class="hljs-keyword">this</span>.options.order});
          }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }, <span class="hljs-keyword">this</span>),
      open      : _.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, ui)</span> {</span>
        <span class="hljs-keyword">var</span> box = <span class="hljs-keyword">this</span>.box;
        <span class="hljs-keyword">this</span>.box.autocomplete(<span class="hljs-string">'widget'</span>).find(<span class="hljs-string">'.ui-menu-item'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">var</span> $value = $(<span class="hljs-keyword">this</span>),
              autoCompleteData = $value.data(<span class="hljs-string">'item.autocomplete'</span>) || $value.data(<span class="hljs-string">'ui-autocomplete-item'</span>);

          <span class="hljs-keyword">if</span> (autoCompleteData[<span class="hljs-string">'value'</span>] == box.val() &amp;&amp; box.data(<span class="hljs-string">'ui-autocomplete'</span>).menu.activate) {
            box.data(<span class="hljs-string">'ui-autocomplete'</span>).menu.activate(<span class="hljs-keyword">new</span> $.Event(<span class="hljs-string">"mouseover"</span>), $value);
          }
        });
      }, <span class="hljs-keyword">this</span>)
    });

    <span class="hljs-keyword">this</span>.box.autocomplete(<span class="hljs-string">'widget'</span>).addClass(<span class="hljs-string">'VS-interface'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>As the facet’s input field grows, it may move to the next line in the
search box. <code>autoGrowInput</code> triggers an <code>updated</code> event on the input
field, which is bound to this method to move the autocomplete menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  moveAutocomplete : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> autocomplete = <span class="hljs-keyword">this</span>.box.data(<span class="hljs-string">'ui-autocomplete'</span>);
    <span class="hljs-keyword">if</span> (autocomplete) {
      autocomplete.menu.element.position({
        my        : <span class="hljs-string">"left top"</span>,
        at        : <span class="hljs-string">"left bottom"</span>,
        of        : <span class="hljs-keyword">this</span>.box.data(<span class="hljs-string">'ui-autocomplete'</span>).element,
        collision : <span class="hljs-string">"flip"</span>,
        offset    : <span class="hljs-string">"0 5"</span>
      });
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>When a user enters a facet and it is being edited, immediately show
the autocomplete menu and size it to match the contents.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  searchAutocomplete : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">var</span> autocomplete = <span class="hljs-keyword">this</span>.box.data(<span class="hljs-string">'ui-autocomplete'</span>);
    <span class="hljs-keyword">if</span> (autocomplete) {
      <span class="hljs-keyword">var</span> menu = autocomplete.menu.element;
      autocomplete.search();</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Resize the menu based on the correctly measured width of what’s bigger:
the menu’s original size or the menu items’ new size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      menu.outerWidth(<span class="hljs-built_in">Math</span>.max(
        menu.width(<span class="hljs-string">''</span>).outerWidth(),
        autocomplete.element.outerWidth()
      ));
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Closes the autocomplete menu. Called on disabling, selecting, deselecting,
and anything else that takes focus out of the facet’s input field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  closeAutocomplete : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> autocomplete = <span class="hljs-keyword">this</span>.box.data(<span class="hljs-string">'ui-autocomplete'</span>);
    <span class="hljs-keyword">if</span> (autocomplete) autocomplete.close();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Search terms used in the autocomplete menu. These are specific to the facet,
and only match for the facet’s category. The values are then matched on the
first letter of any word in matches, and finally sorted according to the
value’s own category. You can pass <code>preserveOrder</code> as an option in the
<code>facetMatches</code> callback to skip any further ordering done client-side.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  autocompleteValues : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(req, resp)</span> {</span>
    <span class="hljs-keyword">var</span> category = <span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'category'</span>);
    <span class="hljs-keyword">var</span> value    = <span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'value'</span>);
    <span class="hljs-keyword">var</span> searchTerm = req.term;

    <span class="hljs-keyword">this</span>.app.options.callbacks.valueMatches(category, searchTerm, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(matches, options)</span> {</span>
      options = options || {};
      matches = matches || [];

      <span class="hljs-keyword">if</span> (searchTerm &amp;&amp; value != searchTerm) {
        <span class="hljs-keyword">if</span> (options.preserveMatches) {
          resp(matches);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">var</span> re = VS.utils.inflector.escapeRegExp(searchTerm || <span class="hljs-string">''</span>);
          <span class="hljs-keyword">var</span> matcher = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(<span class="hljs-string">'\\b'</span> + re, <span class="hljs-string">'i'</span>);
          matches = $.grep(matches, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span> {</span>
            <span class="hljs-keyword">return</span> matcher.test(item) ||
                   matcher.test(item.value) ||
                   matcher.test(item.label);
        });
        }
      }

      <span class="hljs-keyword">if</span> (options.preserveOrder) {
        resp(matches);
      } <span class="hljs-keyword">else</span> {
        resp(_.sortBy(matches, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(match)</span> {</span>
          <span class="hljs-keyword">if</span> (match == value || match.value == value) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> match;
        }));
      }
    });

  },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Sets the facet’s model’s value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> {</span>
    <span class="hljs-keyword">if</span> (!value) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.model.set({<span class="hljs-string">'value'</span>: value});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Before the searchBox performs a search, we need to close the
autocomplete menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  search : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, direction)</span> {</span>
    <span class="hljs-keyword">if</span> (!direction) direction = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">this</span>.closeAutocomplete();
    <span class="hljs-keyword">this</span>.app.searchBox.searchEvent(e);
    _.defer(_.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, direction, {viewPosition: <span class="hljs-keyword">this</span>.options.order});
    }, <span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Begin editing the facet’s input. This is called when the user enters
the input either from another facet or directly clicking on it.</p>
<p>This method tells all other facets and inputs to disable so it can have
the sole focus. It also prepares the autocompletion menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  enableEdit : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.modes.editing != <span class="hljs-string">'is'</span>) {
      <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'is'</span>, <span class="hljs-string">'editing'</span>);
      <span class="hljs-keyword">this</span>.deselectFacet();
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.box.val() == <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">this</span>.box.val(<span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'value'</span>));
      }
    }

    <span class="hljs-keyword">this</span>.flags.canClose = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.app.searchBox.disableFacets(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.app.searchBox.addFocus();
    _.defer(_.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">this</span>.app.searchBox.addFocus();
    }, <span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.resize();
    <span class="hljs-keyword">this</span>.searchAutocomplete();
    <span class="hljs-keyword">this</span>.box.focus();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>When the user blurs the input, they may either be going to another input
or off the search box entirely. If they go to another input, this facet
will be instantly disabled, and the canClose flag will be turned back off.</p>
<p>However, if the user clicks elsewhere on the page, this method starts a timer
that checks if any of the other inputs are selected or are being edited. If
not, then it can finally close itself and its autocomplete menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deferDisableEdit : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.flags.canClose = <span class="hljs-literal">true</span>;
    _.delay(_.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flags.canClose &amp;&amp; !<span class="hljs-keyword">this</span>.box.is(<span class="hljs-string">':focus'</span>) &amp;&amp;
          <span class="hljs-keyword">this</span>.modes.editing == <span class="hljs-string">'is'</span> &amp;&amp; <span class="hljs-keyword">this</span>.modes.selected != <span class="hljs-string">'is'</span>) {
        <span class="hljs-keyword">this</span>.disableEdit();
      }
    }, <span class="hljs-keyword">this</span>), <span class="hljs-number">250</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Called either by other facets receiving focus or by the timer in <code>deferDisableEdit</code>,
this method will turn off the facet, remove any text selection, and close
the autocomplete menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  disableEdit : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> newFacetQuery = VS.utils.inflector.trim(<span class="hljs-keyword">this</span>.box.val());
    <span class="hljs-keyword">if</span> (newFacetQuery != <span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'value'</span>)) {
      <span class="hljs-keyword">this</span>.set(newFacetQuery);
    }
    <span class="hljs-keyword">this</span>.flags.canClose = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.box.selectRange(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">this</span>.box.blur();
    <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'not'</span>, <span class="hljs-string">'editing'</span>);
    <span class="hljs-keyword">this</span>.closeAutocomplete();
    <span class="hljs-keyword">this</span>.app.searchBox.removeFocus();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Selects the facet, which blurs the facet’s input and highlights the facet.
If this is the only facet being selected (and not part of a select all event),
we attach a mouse/keyboard watcher to check if the next action by the user
should delete this facet or just deselect it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selectFacet : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">if</span> (e) e.preventDefault();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> allSelected = <span class="hljs-keyword">this</span>.app.searchBox.allSelected();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.modes.selected == <span class="hljs-string">'is'</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.box.is(<span class="hljs-string">':focus'</span>)) {
      <span class="hljs-keyword">this</span>.box.setCursorPosition(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">this</span>.box.blur();
    }

    <span class="hljs-keyword">this</span>.flags.canClose = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.closeAutocomplete();
    <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'is'</span>, <span class="hljs-string">'selected'</span>);
    <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'not'</span>, <span class="hljs-string">'editing'</span>);
    <span class="hljs-keyword">if</span> (!allSelected || e) {
      $(document).unbind(<span class="hljs-string">'keydown.facet'</span>, <span class="hljs-keyword">this</span>.keydown);
      $(document).unbind(<span class="hljs-string">'click.facet'</span>, <span class="hljs-keyword">this</span>.deselectFacet);
      _.defer(_.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        $(document).unbind(<span class="hljs-string">'keydown.facet'</span>).bind(<span class="hljs-string">'keydown.facet'</span>, <span class="hljs-keyword">this</span>.keydown);
        $(document).unbind(<span class="hljs-string">'click.facet'</span>).one(<span class="hljs-string">'click.facet'</span>, <span class="hljs-keyword">this</span>.deselectFacet);
      }, <span class="hljs-keyword">this</span>));
      <span class="hljs-keyword">this</span>.app.searchBox.disableFacets(<span class="hljs-keyword">this</span>);
      <span class="hljs-keyword">this</span>.app.searchBox.addFocus();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Turns off highlighting on the facet. Called in a variety of ways, this
only deselects the facet if it is selected, and then cleans up the
keyboard/mouse watchers that were created when the facet was first
selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deselectFacet : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">if</span> (e) e.preventDefault();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.modes.selected == <span class="hljs-string">'is'</span>) {
      <span class="hljs-keyword">this</span>.setMode(<span class="hljs-string">'not'</span>, <span class="hljs-string">'selected'</span>);
      <span class="hljs-keyword">this</span>.closeAutocomplete();
      <span class="hljs-keyword">this</span>.app.searchBox.removeFocus();
    }
    $(document).unbind(<span class="hljs-string">'keydown.facet'</span>, <span class="hljs-keyword">this</span>.keydown);
    $(document).unbind(<span class="hljs-string">'click.facet'</span>, <span class="hljs-keyword">this</span>.deselectFacet);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Is the user currently focused in this facet’s input field?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isFocused : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.box.is(<span class="hljs-string">':focus'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Hovering over the delete button styles the facet so the user knows that
the delete button will kill the entire facet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  showDelete : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    $(<span class="hljs-keyword">this</span>.el).addClass(<span class="hljs-string">'search_facet_maybe_delete'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>On <code>mouseout</code>, the user is no longer hovering on the delete button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hideDelete : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    $(<span class="hljs-keyword">this</span>.el).removeClass(<span class="hljs-string">'search_facet_maybe_delete'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>When switching between facets, depending on the direction the cursor is
coming from, the cursor in this facet’s input field should match the original
direction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setCursorAtEnd : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(direction)</span> {</span>
    <span class="hljs-keyword">if</span> (direction == -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.box.setCursorPosition(<span class="hljs-keyword">this</span>.box.val().length);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.box.setCursorPosition(<span class="hljs-number">0</span>);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Deletes the facet and sends the cursor over to the nearest input field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remove : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">var</span> committed = <span class="hljs-keyword">this</span>.model.get(<span class="hljs-string">'value'</span>);
    <span class="hljs-keyword">this</span>.deselectFacet();
    <span class="hljs-keyword">this</span>.disableEdit();
    <span class="hljs-keyword">this</span>.app.searchQuery.remove(<span class="hljs-keyword">this</span>.model);
    <span class="hljs-keyword">if</span> (committed &amp;&amp; <span class="hljs-keyword">this</span>.app.options.autosearch) {
      <span class="hljs-keyword">this</span>.search(e, -<span class="hljs-number">1</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.app.searchBox.renderFacets();
      <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, -<span class="hljs-number">1</span>, {viewPosition: <span class="hljs-keyword">this</span>.options.order});
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Selects the text in the facet’s input field. When the user tabs between
facets, convention is to highlight the entire field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selectText: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.box.selectRange(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.box.val().length);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Handles all keyboard inputs when in the facet’s input field. This checks
for movement between facets and inputs, entering a new value that needs
to be autocompleted, as well as the removal of this facet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  keydown : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">var</span> key = VS.app.hotkeys.key(e);

    <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'enter'</span> &amp;&amp; <span class="hljs-keyword">this</span>.box.val()) {
      <span class="hljs-keyword">this</span>.disableEdit();
      <span class="hljs-keyword">this</span>.search(e);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'left'</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.modes.selected == <span class="hljs-string">'is'</span>) {
        <span class="hljs-keyword">this</span>.deselectFacet();
        <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, -<span class="hljs-number">1</span>, {startAtEnd: -<span class="hljs-number">1</span>});
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.box.getCursorPosition() == <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-keyword">this</span>.box.getSelection().length) {
        <span class="hljs-keyword">this</span>.selectFacet();
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'right'</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.modes.selected == <span class="hljs-string">'is'</span>) {
        e.preventDefault();
        <span class="hljs-keyword">this</span>.deselectFacet();
        <span class="hljs-keyword">this</span>.setCursorAtEnd(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">this</span>.enableEdit();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.box.getCursorPosition() == <span class="hljs-keyword">this</span>.box.val().length) {
        e.preventDefault();
        <span class="hljs-keyword">this</span>.disableEdit();
        <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, <span class="hljs-number">1</span>);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VS.app.hotkeys.shift &amp;&amp; key == <span class="hljs-string">'tab'</span>) {
      e.preventDefault();
      <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, -<span class="hljs-number">1</span>, {
        startAtEnd  : -<span class="hljs-number">1</span>,
        skipToFacet : <span class="hljs-literal">true</span>,
        selectText  : <span class="hljs-literal">true</span>
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'tab'</span>) {
      e.preventDefault();
      <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, <span class="hljs-number">1</span>, {
        skipToFacet : <span class="hljs-literal">true</span>,
        selectText  : <span class="hljs-literal">true</span>
      });
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VS.app.hotkeys.command &amp;&amp; (e.which == <span class="hljs-number">97</span> || e.which == <span class="hljs-number">65</span>)) {
      e.preventDefault();
      <span class="hljs-keyword">this</span>.app.searchBox.selectAllFacets();
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (VS.app.hotkeys.printable(e) &amp;&amp; <span class="hljs-keyword">this</span>.modes.selected == <span class="hljs-string">'is'</span>) {
      <span class="hljs-keyword">this</span>.app.searchBox.focusNextFacet(<span class="hljs-keyword">this</span>, -<span class="hljs-number">1</span>, {startAtEnd: -<span class="hljs-number">1</span>});
      <span class="hljs-keyword">this</span>.remove(e);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key == <span class="hljs-string">'backspace'</span>) {
       $(document).on(<span class="hljs-string">'keydown.backspace'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
          <span class="hljs-keyword">if</span> (VS.app.hotkeys.key(e) === <span class="hljs-string">'backspace'</span>) {
             e.preventDefault();
          }
       });

       $(document).on(<span class="hljs-string">'keyup.backspace'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
          $(document).off(<span class="hljs-string">'.backspace'</span>);
       });

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.modes.selected == <span class="hljs-string">'is'</span>) {
        e.preventDefault();
        <span class="hljs-keyword">this</span>.remove(e);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.box.getCursorPosition() == <span class="hljs-number">0</span> &amp;&amp;
                 !<span class="hljs-keyword">this</span>.box.getSelection().length) {
        e.preventDefault();
        <span class="hljs-keyword">this</span>.selectFacet();
      }
       e.stopPropagation();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Handle paste events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (e.which == <span class="hljs-literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>this.searchAutocomplete(e);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _.defer(_.bind(<span class="hljs-keyword">this</span>.resize, <span class="hljs-keyword">this</span>, e));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.resize(e);
    }
  }

});

})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
