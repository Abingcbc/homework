<!DOCTYPE html>

<html>
<head>
  <title>search_box.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="search_facets.html">
                search_facets.js
              </a>
            
              
              <a class="source" href="search_query.html">
                search_query.js
              </a>
            
              
              <a class="source" href="templates.html">
                templates.js
              </a>
            
              
              <a class="source" href="backbone_extensions.html">
                backbone_extensions.js
              </a>
            
              
              <a class="source" href="hotkeys.html">
                hotkeys.js
              </a>
            
              
              <a class="source" href="inflector.html">
                inflector.js
              </a>
            
              
              <a class="source" href="jquery_extensions.html">
                jquery_extensions.js
              </a>
            
              
              <a class="source" href="search_parser.html">
                search_parser.js
              </a>
            
              
              <a class="source" href="search_box.html">
                search_box.js
              </a>
            
              
              <a class="source" href="search_facet.html">
                search_facet.js
              </a>
            
              
              <a class="source" href="search_input.html">
                search_input.js
              </a>
            
              
              <a class="source" href="visualsearch.html">
                visualsearch.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>search_box.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

<span class="hljs-keyword">var</span> $ = jQuery; <span class="hljs-comment">// Handle namespaced jQuery</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The search box is responsible for managing the many facet views and input views.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>VS.ui.SearchBox = Backbone.View.extend({

  id  : <span class="hljs-string">'search'</span>,

  events : {
    <span class="hljs-string">'click .VS-cancel-search-box'</span> : <span class="hljs-string">'clearSearch'</span>,
    <span class="hljs-string">'mousedown .VS-search-box'</span>    : <span class="hljs-string">'maybeFocusSearch'</span>,
    <span class="hljs-string">'dblclick .VS-search-box'</span>     : <span class="hljs-string">'highlightSearch'</span>,
    <span class="hljs-string">'click .VS-search-box'</span>        : <span class="hljs-string">'maybeTripleClick'</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Creating a new SearchBox registers handlers for re-rendering facets when necessary,
as well as handling typing when a facet is selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  initialize : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options)</span> {</span>
    <span class="hljs-keyword">this</span>.options = _.extend({}, <span class="hljs-keyword">this</span>.options, options);

    <span class="hljs-keyword">this</span>.app = <span class="hljs-keyword">this</span>.options.app;
    <span class="hljs-keyword">this</span>.flags = {
      allSelected : <span class="hljs-literal">false</span>
    };
    <span class="hljs-keyword">this</span>.facetViews = [];
    <span class="hljs-keyword">this</span>.inputViews = [];
    _.bindAll(<span class="hljs-keyword">this</span>, <span class="hljs-string">'renderFacets'</span>, <span class="hljs-string">'_maybeDisableFacets'</span>, <span class="hljs-string">'disableFacets'</span>,
              <span class="hljs-string">'deselectAllFacets'</span>, <span class="hljs-string">'addedFacet'</span>, <span class="hljs-string">'removedFacet'</span>, <span class="hljs-string">'changedFacet'</span>);
    <span class="hljs-keyword">this</span>.app.searchQuery
            .bind(<span class="hljs-string">'reset'</span>, <span class="hljs-keyword">this</span>.renderFacets)
            .bind(<span class="hljs-string">'add'</span>, <span class="hljs-keyword">this</span>.addedFacet)
            .bind(<span class="hljs-string">'remove'</span>, <span class="hljs-keyword">this</span>.removedFacet)
            .bind(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.changedFacet);
    $(document).bind(<span class="hljs-string">'keydown'</span>, <span class="hljs-keyword">this</span>._maybeDisableFacets);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Renders the search box, but requires placement on the page through <code>this.el</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    $(<span class="hljs-keyword">this</span>.el).append(JST[<span class="hljs-string">'search_box'</span>]({
      readOnly: <span class="hljs-keyword">this</span>.app.options.readOnly
    }));
    $(document.body).setMode(<span class="hljs-string">'no'</span>, <span class="hljs-string">'search'</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h1 id="querying-facets">Querying Facets</h1>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Either gets a serialized query string or sets the faceted query from a query string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  value : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span> {</span>
    <span class="hljs-keyword">if</span> (query == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.serialize();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.setQuery(query);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Uses the VS.app.searchQuery collection to serialize the current query from the various
facets that are in the search box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  serialize : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> query           = [];
    <span class="hljs-keyword">var</span> inputViewsCount = <span class="hljs-keyword">this</span>.inputViews.length;

    <span class="hljs-keyword">this</span>.app.searchQuery.each(_.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, i)</span> {</span>
      query.push(<span class="hljs-keyword">this</span>.inputViews[i].value());
      query.push(facet.serialize());
    }, <span class="hljs-keyword">this</span>));

    <span class="hljs-keyword">if</span> (inputViewsCount) {
      query.push(<span class="hljs-keyword">this</span>.inputViews[inputViewsCount-<span class="hljs-number">1</span>].value());
    }

    <span class="hljs-keyword">return</span> _.compact(query).join(<span class="hljs-string">' '</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Returns any facet views that are currently selected. Useful for changing the value
callbacks based on what else is in the search box and which facet is being edited.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selected: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> _.select(<span class="hljs-keyword">this</span>.facetViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
      <span class="hljs-keyword">return</span> view.modes.editing == <span class="hljs-string">'is'</span> || view.modes.selected == <span class="hljs-string">'is'</span>;
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Similar to <code>this.selected</code>, returns any facet models that are currently selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selectedModels: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> _.pluck(<span class="hljs-keyword">this</span>.selected(), <span class="hljs-string">'model'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Takes a query string and uses the SearchParser to parse and render it. Note that
<code>VS.app.SearchParser</code> refreshes the <code>VS.app.searchQuery</code> collection, which is bound
here to call <code>this.renderFacets</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setQuery : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(query)</span> {</span>
    <span class="hljs-keyword">this</span>.currentQuery = query;
    VS.app.SearchParser.parse(<span class="hljs-keyword">this</span>.app, query);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Returns the position of a facet/input view. Useful when moving between facets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  viewPosition : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
    <span class="hljs-keyword">var</span> views    = view.type == <span class="hljs-string">'facet'</span> ? <span class="hljs-keyword">this</span>.facetViews : <span class="hljs-keyword">this</span>.inputViews;
    <span class="hljs-keyword">var</span> position = _.indexOf(views, view);
    <span class="hljs-keyword">if</span> (position == -<span class="hljs-number">1</span>) position = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> position;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Used to launch a search. Hitting enter or clicking the search button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  searchEvent : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">var</span> query = <span class="hljs-keyword">this</span>.value();
    <span class="hljs-keyword">this</span>.focusSearch(e);
    <span class="hljs-keyword">this</span>.value(query);
    <span class="hljs-keyword">this</span>.app.options.callbacks.search(query, <span class="hljs-keyword">this</span>.app.searchQuery);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h1 id="rendering-facets">Rendering Facets</h1>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Add a new facet. Facet will be focused and ready to accept a value. Can also
specify position, in the case of adding facets from an inbetween input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addFacet : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(category, initialQuery, position)</span> {</span>
    category     = VS.utils.inflector.trim(category);
    initialQuery = VS.utils.inflector.trim(initialQuery || <span class="hljs-string">''</span>);
    <span class="hljs-keyword">if</span> (!category) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">new</span> VS.model.SearchFacet({
      category : category,
      value    : initialQuery || <span class="hljs-string">''</span>,
      app      : <span class="hljs-keyword">this</span>.app
    });
    <span class="hljs-keyword">this</span>.app.searchQuery.add(model, {at: position});
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Renders a newly added facet, and selects it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addedFacet : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(model)</span> {</span>
    <span class="hljs-keyword">this</span>.renderFacets();
    <span class="hljs-keyword">var</span> facetView = _.detect(<span class="hljs-keyword">this</span>.facetViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
      <span class="hljs-keyword">if</span> (view.model == model) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    });

    _.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      facetView.enableEdit();
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Changing a facet programmatically re-renders it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  changedFacet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.renderFacets();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>When removing a facet, potentially do something. For now, the adjacent
remaining facet is selected, but this is handled by the facet’s view,
since its position is unknown by the time the collection triggers this
remove callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removedFacet : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(facet, query, options)</span> {</span>
    <span class="hljs-keyword">this</span>.app.options.callbacks.removedFacet(facet, query, options);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Renders each facet as a searchFacet view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderFacets : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.facetViews = [];
    <span class="hljs-keyword">this</span>.inputViews = [];

    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-search-inner'</span>).empty();

    <span class="hljs-keyword">this</span>.app.searchQuery.each(_.bind(<span class="hljs-keyword">this</span>.renderFacet, <span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Add on an n+1 empty search input on the very end.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.renderSearchInput();
    <span class="hljs-keyword">this</span>.renderPlaceholder();
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Render a single facet, using its category and query value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderFacet : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facet, position)</span> {</span>
    <span class="hljs-keyword">var</span> view = <span class="hljs-keyword">new</span> VS.ui.SearchFacet({
      app   : <span class="hljs-keyword">this</span>.app,
      model : facet,
      order : position
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Input first, facet second.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.renderSearchInput();
    <span class="hljs-keyword">this</span>.facetViews.push(view);
    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-search-inner'</span>).children().eq(position*<span class="hljs-number">2</span>).after(view.render().el);

    view.calculateSize();
    _.defer(_.bind(view.calculateSize, view));

    <span class="hljs-keyword">return</span> view;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Render a single input, used to create and autocomplete facets</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderSearchInput : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> input = <span class="hljs-keyword">new</span> VS.ui.SearchInput({
      position: <span class="hljs-keyword">this</span>.inputViews.length,
      app: <span class="hljs-keyword">this</span>.app,
      showFacets: <span class="hljs-keyword">this</span>.options.showFacets
    });
    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-search-inner'</span>).append(input.render().el);
    <span class="hljs-keyword">this</span>.inputViews.push(input);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Handles showing/hiding the placeholder text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  renderPlaceholder : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> $placeholder = <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-placeholder'</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.searchQuery.length) {
      $placeholder.addClass(<span class="hljs-string">"VS-hidden"</span>);
    } <span class="hljs-keyword">else</span> {
      $placeholder.removeClass(<span class="hljs-string">"VS-hidden"</span>)
                  .text(<span class="hljs-keyword">this</span>.app.options.placeholder);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h1 id="modifying-facets">Modifying Facets</h1>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Clears out the search box. Command+A + delete can trigger this, as can a cancel button.</p>
<p>If a <code>clearSearch</code> callback was provided, the callback is invoked and
provided with a function performs the actual removal of the data.  This
allows third-party developers to either clear data asynchronously, or
prior to performing their custom “clear” logic.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clearSearch : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> actualClearSearch = _.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">this</span>.disableFacets();
      <span class="hljs-keyword">this</span>.value(<span class="hljs-string">''</span>);
      <span class="hljs-keyword">this</span>.flags.allSelected = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">this</span>.searchEvent(e);
      <span class="hljs-keyword">this</span>.focusSearch(e);
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.callbacks.clearSearch != $.noop) {
      <span class="hljs-keyword">this</span>.app.options.callbacks.clearSearch(actualClearSearch);
    } <span class="hljs-keyword">else</span> {
      actualClearSearch();
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Command+A selects all facets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selectAllFacets : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.flags.allSelected = <span class="hljs-literal">true</span>;

    $(document).one(<span class="hljs-string">'click.selectAllFacets'</span>, <span class="hljs-keyword">this</span>.deselectAllFacets);

    _.each(<span class="hljs-keyword">this</span>.facetViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facetView, i)</span> {</span>
      facetView.selectFacet();
    });
    _.each(<span class="hljs-keyword">this</span>.inputViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(inputView, i)</span> {</span>
      inputView.selectText();
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Used by facets and input to see if all facets are currently selected.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  allSelected : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(deselect)</span> {</span>
    <span class="hljs-keyword">if</span> (deselect) <span class="hljs-keyword">this</span>.flags.allSelected = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.flags.allSelected;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>After <code>selectAllFacets</code> is engaged, this method is bound to the entire document.
This immediate disables and deselects all facets, but it also checks if the user
has clicked on either a facet or an input, and properly selects the view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  deselectAllFacets : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">this</span>.disableFacets();

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$(e.target).is(<span class="hljs-string">'.category,input'</span>)) {
      <span class="hljs-keyword">var</span> el   = $(e.target).closest(<span class="hljs-string">'.search_facet,.search_input'</span>);
      <span class="hljs-keyword">var</span> view = _.detect(<span class="hljs-keyword">this</span>.facetViews.concat(<span class="hljs-keyword">this</span>.inputViews), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> {</span>
        <span class="hljs-keyword">return</span> v.el == el[<span class="hljs-number">0</span>];
      });
      <span class="hljs-keyword">if</span> (view.type == <span class="hljs-string">'facet'</span>) {
        view.selectFacet();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.type == <span class="hljs-string">'input'</span>) {
        _.defer(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          view.enableEdit(<span class="hljs-literal">true</span>);
        });
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Disables all facets except for the passed in view. Used when switching between
facets, so as not to have to keep state of active facets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  disableFacets : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(keepView)</span> {</span>
    _.each(<span class="hljs-keyword">this</span>.inputViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
      <span class="hljs-keyword">if</span> (view &amp;&amp; view != keepView &amp;&amp;
          (view.modes.editing == <span class="hljs-string">'is'</span> || view.modes.selected == <span class="hljs-string">'is'</span>)) {
        view.disableEdit();
      }
    });
    _.each(<span class="hljs-keyword">this</span>.facetViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
      <span class="hljs-keyword">if</span> (view &amp;&amp; view != keepView &amp;&amp;
          (view.modes.editing == <span class="hljs-string">'is'</span> || view.modes.selected == <span class="hljs-string">'is'</span>)) {
        view.disableEdit();
        view.deselectFacet();
      }
    });

    <span class="hljs-keyword">this</span>.flags.allSelected = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.removeFocus();
    $(document).unbind(<span class="hljs-string">'click.selectAllFacets'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Resize all inputs to account for extra keystrokes which may be changing the facet
width incorrectly. This is a safety check to ensure inputs are correctly sized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  resizeFacets : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
    _.each(<span class="hljs-keyword">this</span>.facetViews, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(facetView, i)</span> {</span>
      <span class="hljs-keyword">if</span> (!view || facetView == view) {
        facetView.resize();
      }
    });
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Handles keydown events on the document. Used to complete the Cmd+A deletion, and
blurring focus.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _maybeDisableFacets : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flags.allSelected &amp;&amp; VS.app.hotkeys.key(e) == <span class="hljs-string">'backspace'</span>) {
      e.preventDefault();
      <span class="hljs-keyword">this</span>.clearSearch(e);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.flags.allSelected &amp;&amp; VS.app.hotkeys.printable(e)) {
      <span class="hljs-keyword">this</span>.clearSearch(e);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h1 id="focusing-facets">Focusing Facets</h1>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Move focus between facets and inputs. Takes a direction as well as many options
for skipping over inputs and only to facets, placement of cursor position in facet
(i.e. at the end), and selecting the text in the input/facet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  focusNextFacet : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(currentView, direction, options)</span> {</span>
    options = options || {};
    <span class="hljs-keyword">var</span> viewCount    = <span class="hljs-keyword">this</span>.facetViews.length;
    <span class="hljs-keyword">var</span> viewPosition = options.viewPosition || <span class="hljs-keyword">this</span>.viewPosition(currentView);

    <span class="hljs-keyword">if</span> (!options.skipToFacet) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Correct for bouncing between matching text and facet arrays.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (currentView.type == <span class="hljs-string">'text'</span>  &amp;&amp; direction &gt; <span class="hljs-number">0</span>) direction -= <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (currentView.type == <span class="hljs-string">'facet'</span> &amp;&amp; direction &lt; <span class="hljs-number">0</span>) direction += <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options.skipToFacet &amp;&amp; currentView.type == <span class="hljs-string">'text'</span> &amp;&amp;
               viewCount == viewPosition &amp;&amp; direction &gt;= <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Special case of looping around to a facet from the last search input box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">var</span> view, next = <span class="hljs-built_in">Math</span>.min(viewCount, viewPosition + direction);

    <span class="hljs-keyword">if</span> (currentView.type == <span class="hljs-string">'text'</span>) {
      <span class="hljs-keyword">if</span> (next &gt;= <span class="hljs-number">0</span> &amp;&amp; next &lt; viewCount) {
        view = <span class="hljs-keyword">this</span>.facetViews[next];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (next == viewCount) {
        view = <span class="hljs-keyword">this</span>.inputViews[<span class="hljs-keyword">this</span>.inputViews.length-<span class="hljs-number">1</span>];
      }
      <span class="hljs-keyword">if</span> (view &amp;&amp; options.selectFacet &amp;&amp; view.type == <span class="hljs-string">'facet'</span>) {
        view.selectFacet();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view) {
        view.enableEdit();
        view.setCursorAtEnd(direction || options.startAtEnd);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentView.type == <span class="hljs-string">'facet'</span>) {
      <span class="hljs-keyword">if</span> (options.skipToFacet) {
        <span class="hljs-keyword">if</span> (next &gt;= viewCount || next &lt; <span class="hljs-number">0</span>) {
          view = _.last(<span class="hljs-keyword">this</span>.inputViews);
          view.enableEdit();
        } <span class="hljs-keyword">else</span> {
          view = <span class="hljs-keyword">this</span>.facetViews[next];
          view.enableEdit();
          view.setCursorAtEnd(direction || options.startAtEnd);
        }
      } <span class="hljs-keyword">else</span> {
        view = <span class="hljs-keyword">this</span>.inputViews[next];
        view.enableEdit();
      }
    }
    <span class="hljs-keyword">if</span> (options.selectText) view.selectText();
    <span class="hljs-keyword">this</span>.resizeFacets();

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },

  maybeFocusSearch : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> ($(e.target).is(<span class="hljs-string">'.VS-search-box'</span>) ||
        $(e.target).is(<span class="hljs-string">'.VS-search-inner'</span>) ||
        e.type == <span class="hljs-string">'keydown'</span>) {
      <span class="hljs-keyword">this</span>.focusSearch(e);
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Bring focus to last input field.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  focusSearch : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e, selectText)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">var</span> view = <span class="hljs-keyword">this</span>.inputViews[<span class="hljs-keyword">this</span>.inputViews.length-<span class="hljs-number">1</span>];
    view.enableEdit(selectText);
    <span class="hljs-keyword">if</span> (!selectText) view.setCursorAtEnd(-<span class="hljs-number">1</span>);
    <span class="hljs-keyword">if</span> (e.type == <span class="hljs-string">'keydown'</span>) {
      view.keydown(e);
      view.box.trigger(<span class="hljs-string">'keydown'</span>);
    }
    _.defer(_.bind(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.$(<span class="hljs-string">'input:focus'</span>).length) {
        view.enableEdit(selectText);
      }
    }, <span class="hljs-keyword">this</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Double-clicking on the search wrapper should select the existing text in
the last search input. Also start the triple-click timer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  highlightSearch : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> ($(e.target).is(<span class="hljs-string">'.VS-search-box'</span>) ||
        $(e.target).is(<span class="hljs-string">'.VS-search-inner'</span>) ||
        e.type == <span class="hljs-string">'keydown'</span>) {
      <span class="hljs-keyword">var</span> lastinput = <span class="hljs-keyword">this</span>.inputViews[<span class="hljs-keyword">this</span>.inputViews.length-<span class="hljs-number">1</span>];
      lastinput.startTripleClickTimer();
      <span class="hljs-keyword">this</span>.focusSearch(e, <span class="hljs-literal">true</span>);
    }
  },

  maybeTripleClick : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    <span class="hljs-keyword">var</span> lastinput = <span class="hljs-keyword">this</span>.inputViews[<span class="hljs-keyword">this</span>.inputViews.length-<span class="hljs-number">1</span>];
    <span class="hljs-keyword">return</span> lastinput.maybeTripleClick(e);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Used to show the user is focused on some input inside the search box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  addFocus : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.app.options.readOnly) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.app.options.callbacks.focus();
    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-search-box'</span>).addClass(<span class="hljs-string">'VS-focus'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>User is no longer focused on anything in the search box.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeFocus : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">this</span>.app.options.callbacks.blur();
    <span class="hljs-keyword">var</span> focus = _.any(<span class="hljs-keyword">this</span>.facetViews.concat(<span class="hljs-keyword">this</span>.inputViews), <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(view)</span> {</span>
      <span class="hljs-keyword">return</span> view.isFocused();
    });
    <span class="hljs-keyword">if</span> (!focus) <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-search-box'</span>).removeClass(<span class="hljs-string">'VS-focus'</span>);
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Show a menu which adds pre-defined facets to the search box. This is unused for now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  showFacetCategoryMenu : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
    e.preventDefault();
    e.stopPropagation();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.facetCategoryMenu &amp;&amp; <span class="hljs-keyword">this</span>.facetCategoryMenu.modes.open == <span class="hljs-string">'is'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.facetCategoryMenu.close();
    }

    <span class="hljs-keyword">var</span> items = [
      {title: <span class="hljs-string">'Account'</span>, onClick: _.bind(<span class="hljs-keyword">this</span>.addFacet, <span class="hljs-keyword">this</span>, <span class="hljs-string">'account'</span>, <span class="hljs-string">''</span>)},
      {title: <span class="hljs-string">'Project'</span>, onClick: _.bind(<span class="hljs-keyword">this</span>.addFacet, <span class="hljs-keyword">this</span>, <span class="hljs-string">'project'</span>, <span class="hljs-string">''</span>)},
      {title: <span class="hljs-string">'Filter'</span>, onClick: _.bind(<span class="hljs-keyword">this</span>.addFacet, <span class="hljs-keyword">this</span>, <span class="hljs-string">'filter'</span>, <span class="hljs-string">''</span>)},
      {title: <span class="hljs-string">'Access'</span>, onClick: _.bind(<span class="hljs-keyword">this</span>.addFacet, <span class="hljs-keyword">this</span>, <span class="hljs-string">'access'</span>, <span class="hljs-string">''</span>)}
    ];

    <span class="hljs-keyword">var</span> menu = <span class="hljs-keyword">this</span>.facetCategoryMenu || (<span class="hljs-keyword">this</span>.facetCategoryMenu = <span class="hljs-keyword">new</span> dc.ui.Menu({
      items       : items,
      standalone  : <span class="hljs-literal">true</span>
    }));

    <span class="hljs-keyword">this</span>.$(<span class="hljs-string">'.VS-icon-search'</span>).after(menu.render().open().content);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

});

})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
